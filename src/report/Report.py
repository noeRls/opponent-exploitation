from src.nn.NN import NN
from src.environement.Strategy import Strategy
from src.environement.Kuhn.strategy.best_response import KuhnBestResponseStrategy
from src.environement.Kuhn.strategy.random import RandomStrategy
from src.environement.Kuhn.strategy.always_fold import AlwaysFoldStrategy
from src.environement.Kuhn.strategy.always_bet import AlwaysBetStrategy
from src.environement.Kuhn.strategy.equilibrium import EquilibriumStrategy
from src.train.ea.play_against import play_against
from src.constants import SAVE_MODEL_PATH
from src.utils.plot import save_plot
from src.nn.NNStrategy import NNStrategy
from src.environement.Environment import Environment
from typing import TextIO
import matplotlib.pyplot as plt
import numpy as np

import os

class Report():
    save_path: str
    id: str
    out_file: TextIO
    env: Environment
    strategy: Strategy
    def __init__(self, id: str, save_path: str, env: Environment) -> None:
        self.env = env
        self.id = id
        self.save_path = save_path
        self._init_files()

    def _init_files(self):
        self.save_path = os.path.join(self.save_path, str(self.id))
        if not os.path.exists(self.save_path):
            os.mkdir(self.save_path)
        self.out_file = open(os.path.join(self.save_path, 'report.txt'), "w+", encoding="utf-8")
        print(f'id={self.id}', file=self.out_file)

    def set_strategy(self, strategy: Strategy):
        self.strategy = strategy

    def load_nn_strategy(self, model_size: int):
        self.strategy = NNStrategy(self.env, model_size)
        self.strategy.load(SAVE_MODEL_PATH, self.id)
        NN.store_history = True

    def nn_summary(self, nb_games=25, descision_making=True, opponent_modelling=True):
        play_against(self.env, self.strategy, EquilibriumStrategy(), nb_games)
        play_against(self.env, self.strategy, AlwaysBetStrategy(), nb_games)
        play_against(self.env, self.strategy, AlwaysFoldStrategy(), nb_games)
        play_against(self.env, self.strategy, RandomStrategy(), nb_games)
        if descision_making:
            self.strategy.descision_making_nn.summary(self.save_path)
        if opponent_modelling:
            self.strategy.oppnent_modelling_nn.summary(self.save_path)

    def best_response_report(self):
        best_response_strategy = KuhnBestResponseStrategy()
        result = play_against(self.env, self.strategy, best_response_strategy, 50)
        print(f"best_reponse={result.r2} tested_strategy={result.r1}", file=self.out_file)

    def _plot_reward_over_time(self, opponent: Strategy):
        result = play_against(self.env, self.strategy, opponent, nb_games=1000, history=True)
        _, ax = plt.subplots()
        print(f'{self.strategy.get_name()}={result.r1} f{opponent.get_name()}={result.r2}', file=self.out_file)
        ax.plot([i for i in range(len(result.r1_history[0]))], result.r1_history[0])
        ax.set(xlabel="Game", ylabel="Reward", title=f"{self.strategy.get_name()} reward against {opponent.get_name()} over time")
        save_plot(self.save_path, f'reward-against-{opponent.get_name()}')

    def plot_reward_over_time(self):
        self._plot_reward_over_time(AlwaysBetStrategy())
        self._plot_reward_over_time(AlwaysFoldStrategy())
        self._plot_reward_over_time(EquilibriumStrategy())
        self._plot_reward_over_time(KuhnBestResponseStrategy())
        self._plot_reward_over_time(RandomStrategy())