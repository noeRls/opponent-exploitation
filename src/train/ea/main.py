from src.environement.Kuhn.strategy.best_response import KuhnBestResponseStrategy
from src.environement.Kuhn.strategy.human_strategy import HumanStrategy
from src.environement.Kuhn.strategy.equilibrium import EquilibriumStrategy
from src.nn.NN import NN
from src.constants import SAVE_MODEL_PATH
from src.train.ea.NNIndividual import NNIndividual
from src.nn.NNStrategy import NNStrategy
from src.train.ea.Population import Population, TrainingIndividual
from src.train.ea.Individual import Individual
from src.environement.Strategy import Strategy
from .play_against import play_against
from src.environement.Kuhn.strategy.all_strategy import ALL_KUHN_STRATEGY
from src.environement.Kuhn.KuhnEnv import KuhnEnv
from typing import List
from .Individual import Individual

MODEL_SIZE = 5


def train():
    env = KuhnEnv()
    teaching_individuals: List[Individual] = []
    for S in ALL_KUHN_STRATEGY:
        teaching_individuals.append(Individual(S()))
    TRAINING_NB = 10
    NEW_INDIVIDUAL_PER_ITERATION = 7
    MUTATION_RATE = 0.3
    ITERATION = 20
    training_individuals: List[TrainingIndividual] = [NNIndividual(
        NNStrategy(env, MODEL_SIZE)) for _ in range(TRAINING_NB)]
    population = Population(
        training_individuals=training_individuals,
        new_individual_per_iteration=NEW_INDIVIDUAL_PER_ITERATION,
        mutation_rate=MUTATION_RATE,
        teaching_set=teaching_individuals
    )
    for iteration_nb in range(ITERATION):
        print(f'ITERATION {iteration_nb + 1}')
        population.process_iteration(env)
    individual = population.get_best_individual()
    s: NNStrategy = individual.startegy
    s.save(SAVE_MODEL_PATH)


def analyze(save_id: int):
    env = KuhnEnv()
    nn_strategy = NNStrategy(env, MODEL_SIZE)
    nn_strategy.load(SAVE_MODEL_PATH, save_id)
    NN.store_history = True
    play_against(env, nn_strategy, EquilibriumStrategy(), 100)
    nn_strategy.descision_making_nn.summary()


def best_response_report(env: KuhnEnv, strategy: Strategy):
    best_response_strategy = KuhnBestResponseStrategy()
    r1, r2 = play_against(env, strategy, best_response_strategy, 100)
    print(f"best_reponse={r2} tested_strategy={r1}")


def play_with_human(save_id: int, nb_games=5):
    env = KuhnEnv()
    nn_strategy = NNStrategy(env, MODEL_SIZE)
    nn_strategy.load(SAVE_MODEL_PATH, save_id)
    human_strategy = HumanStrategy()
    play_against(env, nn_strategy, human_strategy, nb_games, debug=True)


def main():
    # train()
    analyze(150)
